import { Injectable } from '@angular/core';
import { forkJoin, of } from 'rxjs';
import { concatMap, map } from 'rxjs/operators';
import { EventTypes } from '../public-events/event-types';
import { DEFAULT_CONFIG } from './default-config';
import * as i0 from "@angular/core";
import * as i1 from "../logging/logger.service";
import * as i2 from "../public-events/public-events.service";
import * as i3 from "../storage/storage-persistence.service";
import * as i4 from "./validation/config-validation.service";
import * as i5 from "../utils/platform-provider/platform.provider";
import * as i6 from "./auth-well-known/auth-well-known.service";
import * as i7 from "./loader/config-loader";
export class ConfigurationService {
    constructor(loggerService, publicEventsService, storagePersistenceService, configValidationService, platformProvider, authWellKnownService, loader) {
        this.loggerService = loggerService;
        this.publicEventsService = publicEventsService;
        this.storagePersistenceService = storagePersistenceService;
        this.configValidationService = configValidationService;
        this.platformProvider = platformProvider;
        this.authWellKnownService = authWellKnownService;
        this.loader = loader;
        this.configsInternal = {};
    }
    hasManyConfigs() {
        return Object.keys(this.configsInternal).length > 1;
    }
    getAllConfigurations() {
        return Object.values(this.configsInternal);
    }
    getOpenIDConfiguration(configId) {
        if (this.configsAlreadySaved()) {
            return of(this.getConfig(configId));
        }
        return this.getOpenIDConfigurations(configId).pipe(map((result) => result.currentConfig));
    }
    getOpenIDConfigurations(configId) {
        return this.loadConfigs().pipe(concatMap((allConfigs) => this.prepareAndSaveConfigs(allConfigs)), map((allPreparedConfigs) => ({
            allConfigs: allPreparedConfigs,
            currentConfig: this.getConfig(configId),
        })));
    }
    hasAtLeastOneConfig() {
        return Object.keys(this.configsInternal).length > 0;
    }
    saveConfig(readyConfig) {
        const { configId } = readyConfig;
        this.configsInternal[configId] = readyConfig;
    }
    loadConfigs() {
        return this.loader.loadConfigs();
    }
    configsAlreadySaved() {
        return this.hasAtLeastOneConfig();
    }
    getConfig(configId) {
        if (!!configId) {
            return this.configsInternal[configId] || null;
        }
        const [, value] = Object.entries(this.configsInternal)[0] || [[null, null]];
        return value || null;
    }
    prepareAndSaveConfigs(passedConfigs) {
        if (!this.configValidationService.validateConfigs(passedConfigs)) {
            return of(null);
        }
        this.createUniqueIds(passedConfigs);
        const allHandleConfigs$ = passedConfigs.map((x) => this.handleConfig(x));
        return forkJoin(allHandleConfigs$);
    }
    createUniqueIds(passedConfigs) {
        passedConfigs.forEach((config, index) => {
            if (!config.configId) {
                config.configId = `${index}-${config.clientId}`;
            }
        });
    }
    handleConfig(passedConfig) {
        if (!this.configValidationService.validateConfig(passedConfig)) {
            this.loggerService.logError(passedConfig, 'Validation of config rejected with errors. Config is NOT set.');
            return of(null);
        }
        if (!passedConfig.authWellknownEndpointUrl) {
            passedConfig.authWellknownEndpointUrl = passedConfig.authority;
        }
        const usedConfig = this.prepareConfig(passedConfig);
        this.saveConfig(usedConfig);
        const configWithAuthWellKnown = this.enhanceConfigWithWellKnownEndpoint(usedConfig);
        this.publicEventsService.fireEvent(EventTypes.ConfigLoaded, configWithAuthWellKnown);
        return of(usedConfig);
    }
    enhanceConfigWithWellKnownEndpoint(configuration) {
        const alreadyExistingAuthWellKnownEndpoints = this.storagePersistenceService.read('authWellKnownEndPoints', configuration);
        if (!!alreadyExistingAuthWellKnownEndpoints) {
            configuration.authWellknownEndpoints = alreadyExistingAuthWellKnownEndpoints;
            return configuration;
        }
        const passedAuthWellKnownEndpoints = configuration.authWellknownEndpoints;
        if (!!passedAuthWellKnownEndpoints) {
            this.authWellKnownService.storeWellKnownEndpoints(configuration, passedAuthWellKnownEndpoints);
            configuration.authWellknownEndpoints = passedAuthWellKnownEndpoints;
            return configuration;
        }
        return configuration;
    }
    prepareConfig(configuration) {
        const openIdConfigurationInternal = { ...DEFAULT_CONFIG, ...configuration };
        this.setSpecialCases(openIdConfigurationInternal);
        return openIdConfigurationInternal;
    }
    setSpecialCases(currentConfig) {
        if (!this.platformProvider.isBrowser()) {
            currentConfig.startCheckSession = false;
            currentConfig.silentRenew = false;
            currentConfig.useRefreshToken = false;
            currentConfig.usePushedAuthorisationRequests = false;
        }
    }
}
ConfigurationService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: ConfigurationService, deps: [{ token: i1.LoggerService }, { token: i2.PublicEventsService }, { token: i3.StoragePersistenceService }, { token: i4.ConfigValidationService }, { token: i5.PlatformProvider }, { token: i6.AuthWellKnownService }, { token: i7.StsConfigLoader }], target: i0.ɵɵFactoryTarget.Injectable });
ConfigurationService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: ConfigurationService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: ConfigurationService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.LoggerService }, { type: i2.PublicEventsService }, { type: i3.StoragePersistenceService }, { type: i4.ConfigValidationService }, { type: i5.PlatformProvider }, { type: i6.AuthWellKnownService }, { type: i7.StsConfigLoader }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLWF1dGgtb2lkYy1jbGllbnQvc3JjL2xpYi9jb25maWcvY29uZmlnLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsUUFBUSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWhELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUsxRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7Ozs7Ozs7OztBQU1sRCxNQUFNLE9BQU8sb0JBQW9CO0lBRy9CLFlBQ1UsYUFBNEIsRUFDNUIsbUJBQXdDLEVBQ3hDLHlCQUFvRCxFQUNwRCx1QkFBZ0QsRUFDaEQsZ0JBQWtDLEVBQ2xDLG9CQUEwQyxFQUMxQyxNQUF1QjtRQU52QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFDcEQsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNoRCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMsV0FBTSxHQUFOLE1BQU0sQ0FBaUI7UUFUekIsb0JBQWUsR0FBd0MsRUFBRSxDQUFDO0lBVS9ELENBQUM7SUFFSixjQUFjO1FBQ1osT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxvQkFBb0I7UUFDbEIsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsc0JBQXNCLENBQUMsUUFBaUI7UUFDdEMsSUFBSSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsRUFBRTtZQUM5QixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7U0FDckM7UUFFRCxPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUM1RixDQUFDO0lBRUQsdUJBQXVCLENBQUMsUUFBaUI7UUFDdkMsT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxDQUM1QixTQUFTLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUNqRSxHQUFHLENBQUMsQ0FBQyxrQkFBa0IsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMzQixVQUFVLEVBQUUsa0JBQWtCO1lBQzlCLGFBQWEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztTQUN4QyxDQUFDLENBQUMsQ0FDSixDQUFDO0lBQ0osQ0FBQztJQUVELG1CQUFtQjtRQUNqQixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVPLFVBQVUsQ0FBQyxXQUFnQztRQUNqRCxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsV0FBVyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLEdBQUcsV0FBVyxDQUFDO0lBQy9DLENBQUM7SUFFTyxXQUFXO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBRU8sbUJBQW1CO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDcEMsQ0FBQztJQUVPLFNBQVMsQ0FBQyxRQUFnQjtRQUNoQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUU7WUFDZCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUFDO1NBQy9DO1FBRUQsTUFBTSxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRTVFLE9BQU8sS0FBSyxJQUFJLElBQUksQ0FBQztJQUN2QixDQUFDO0lBRU8scUJBQXFCLENBQUMsYUFBb0M7UUFDaEUsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDaEUsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakI7UUFFRCxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BDLE1BQU0saUJBQWlCLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXpFLE9BQU8sUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVPLGVBQWUsQ0FBQyxhQUFvQztRQUMxRCxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3RDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFO2dCQUNwQixNQUFNLENBQUMsUUFBUSxHQUFHLEdBQUcsS0FBSyxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQzthQUNqRDtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFlBQVksQ0FBQyxZQUFpQztRQUNwRCxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsRUFBRTtZQUM5RCxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsK0RBQStELENBQUMsQ0FBQztZQUUzRyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQjtRQUVELElBQUksQ0FBQyxZQUFZLENBQUMsd0JBQXdCLEVBQUU7WUFDMUMsWUFBWSxDQUFDLHdCQUF3QixHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUM7U0FDaEU7UUFFRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFNUIsTUFBTSx1QkFBdUIsR0FBRyxJQUFJLENBQUMsa0NBQWtDLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFcEYsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBc0IsVUFBVSxDQUFDLFlBQVksRUFBRSx1QkFBdUIsQ0FBQyxDQUFDO1FBRTFHLE9BQU8sRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3hCLENBQUM7SUFFTyxrQ0FBa0MsQ0FBQyxhQUFrQztRQUMzRSxNQUFNLHFDQUFxQyxHQUFHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDM0gsSUFBSSxDQUFDLENBQUMscUNBQXFDLEVBQUU7WUFDM0MsYUFBYSxDQUFDLHNCQUFzQixHQUFHLHFDQUFxQyxDQUFDO1lBRTdFLE9BQU8sYUFBYSxDQUFDO1NBQ3RCO1FBRUQsTUFBTSw0QkFBNEIsR0FBRyxhQUFhLENBQUMsc0JBQXNCLENBQUM7UUFDMUUsSUFBSSxDQUFDLENBQUMsNEJBQTRCLEVBQUU7WUFDbEMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLHVCQUF1QixDQUFDLGFBQWEsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO1lBQy9GLGFBQWEsQ0FBQyxzQkFBc0IsR0FBRyw0QkFBNEIsQ0FBQztZQUVwRSxPQUFPLGFBQWEsQ0FBQztTQUN0QjtRQUVELE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyxhQUFhLENBQUMsYUFBa0M7UUFDdEQsTUFBTSwyQkFBMkIsR0FBRyxFQUFFLEdBQUcsY0FBYyxFQUFFLEdBQUcsYUFBYSxFQUFFLENBQUM7UUFDNUUsSUFBSSxDQUFDLGVBQWUsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBRWxELE9BQU8sMkJBQTJCLENBQUM7SUFDckMsQ0FBQztJQUVPLGVBQWUsQ0FBQyxhQUFrQztRQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxFQUFFO1lBQ3RDLGFBQWEsQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUM7WUFDeEMsYUFBYSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7WUFDbEMsYUFBYSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7WUFDdEMsYUFBYSxDQUFDLDhCQUE4QixHQUFHLEtBQUssQ0FBQztTQUN0RDtJQUNILENBQUM7O2lIQTNJVSxvQkFBb0I7cUhBQXBCLG9CQUFvQjsyRkFBcEIsb0JBQW9CO2tCQURoQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBmb3JrSm9pbiwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY29uY2F0TWFwLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IExvZ2dlclNlcnZpY2UgfSBmcm9tICcuLi9sb2dnaW5nL2xvZ2dlci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRXZlbnRUeXBlcyB9IGZyb20gJy4uL3B1YmxpYy1ldmVudHMvZXZlbnQtdHlwZXMnO1xyXG5pbXBvcnQgeyBQdWJsaWNFdmVudHNTZXJ2aWNlIH0gZnJvbSAnLi4vcHVibGljLWV2ZW50cy9wdWJsaWMtZXZlbnRzLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlIH0gZnJvbSAnLi4vc3RvcmFnZS9zdG9yYWdlLXBlcnNpc3RlbmNlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBQbGF0Zm9ybVByb3ZpZGVyIH0gZnJvbSAnLi4vdXRpbHMvcGxhdGZvcm0tcHJvdmlkZXIvcGxhdGZvcm0ucHJvdmlkZXInO1xyXG5pbXBvcnQgeyBBdXRoV2VsbEtub3duU2VydmljZSB9IGZyb20gJy4vYXV0aC13ZWxsLWtub3duL2F1dGgtd2VsbC1rbm93bi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgREVGQVVMVF9DT05GSUcgfSBmcm9tICcuL2RlZmF1bHQtY29uZmlnJztcclxuaW1wb3J0IHsgU3RzQ29uZmlnTG9hZGVyIH0gZnJvbSAnLi9sb2FkZXIvY29uZmlnLWxvYWRlcic7XHJcbmltcG9ydCB7IE9wZW5JZENvbmZpZ3VyYXRpb24gfSBmcm9tICcuL29wZW5pZC1jb25maWd1cmF0aW9uJztcclxuaW1wb3J0IHsgQ29uZmlnVmFsaWRhdGlvblNlcnZpY2UgfSBmcm9tICcuL3ZhbGlkYXRpb24vY29uZmlnLXZhbGlkYXRpb24uc2VydmljZSc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDb25maWd1cmF0aW9uU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBjb25maWdzSW50ZXJuYWw6IFJlY29yZDxzdHJpbmcsIE9wZW5JZENvbmZpZ3VyYXRpb24+ID0ge307XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBsb2dnZXJTZXJ2aWNlOiBMb2dnZXJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBwdWJsaWNFdmVudHNTZXJ2aWNlOiBQdWJsaWNFdmVudHNTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBzdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlOiBTdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBjb25maWdWYWxpZGF0aW9uU2VydmljZTogQ29uZmlnVmFsaWRhdGlvblNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHBsYXRmb3JtUHJvdmlkZXI6IFBsYXRmb3JtUHJvdmlkZXIsXHJcbiAgICBwcml2YXRlIGF1dGhXZWxsS25vd25TZXJ2aWNlOiBBdXRoV2VsbEtub3duU2VydmljZSxcclxuICAgIHByaXZhdGUgbG9hZGVyOiBTdHNDb25maWdMb2FkZXJcclxuICApIHt9XHJcblxyXG4gIGhhc01hbnlDb25maWdzKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuY29uZmlnc0ludGVybmFsKS5sZW5ndGggPiAxO1xyXG4gIH1cclxuXHJcbiAgZ2V0QWxsQ29uZmlndXJhdGlvbnMoKTogT3BlbklkQ29uZmlndXJhdGlvbltdIHtcclxuICAgIHJldHVybiBPYmplY3QudmFsdWVzKHRoaXMuY29uZmlnc0ludGVybmFsKTtcclxuICB9XHJcblxyXG4gIGdldE9wZW5JRENvbmZpZ3VyYXRpb24oY29uZmlnSWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPE9wZW5JZENvbmZpZ3VyYXRpb24+IHtcclxuICAgIGlmICh0aGlzLmNvbmZpZ3NBbHJlYWR5U2F2ZWQoKSkge1xyXG4gICAgICByZXR1cm4gb2YodGhpcy5nZXRDb25maWcoY29uZmlnSWQpKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5nZXRPcGVuSURDb25maWd1cmF0aW9ucyhjb25maWdJZCkucGlwZShtYXAoKHJlc3VsdCkgPT4gcmVzdWx0LmN1cnJlbnRDb25maWcpKTtcclxuICB9XHJcblxyXG4gIGdldE9wZW5JRENvbmZpZ3VyYXRpb25zKGNvbmZpZ0lkPzogc3RyaW5nKTogT2JzZXJ2YWJsZTx7IGFsbENvbmZpZ3M7IGN1cnJlbnRDb25maWcgfT4ge1xyXG4gICAgcmV0dXJuIHRoaXMubG9hZENvbmZpZ3MoKS5waXBlKFxyXG4gICAgICBjb25jYXRNYXAoKGFsbENvbmZpZ3MpID0+IHRoaXMucHJlcGFyZUFuZFNhdmVDb25maWdzKGFsbENvbmZpZ3MpKSxcclxuICAgICAgbWFwKChhbGxQcmVwYXJlZENvbmZpZ3MpID0+ICh7XHJcbiAgICAgICAgYWxsQ29uZmlnczogYWxsUHJlcGFyZWRDb25maWdzLFxyXG4gICAgICAgIGN1cnJlbnRDb25maWc6IHRoaXMuZ2V0Q29uZmlnKGNvbmZpZ0lkKSxcclxuICAgICAgfSkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgaGFzQXRMZWFzdE9uZUNvbmZpZygpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLmNvbmZpZ3NJbnRlcm5hbCkubGVuZ3RoID4gMDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2F2ZUNvbmZpZyhyZWFkeUNvbmZpZzogT3BlbklkQ29uZmlndXJhdGlvbik6IHZvaWQge1xyXG4gICAgY29uc3QgeyBjb25maWdJZCB9ID0gcmVhZHlDb25maWc7XHJcbiAgICB0aGlzLmNvbmZpZ3NJbnRlcm5hbFtjb25maWdJZF0gPSByZWFkeUNvbmZpZztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbG9hZENvbmZpZ3MoKTogT2JzZXJ2YWJsZTxPcGVuSWRDb25maWd1cmF0aW9uW10+IHtcclxuICAgIHJldHVybiB0aGlzLmxvYWRlci5sb2FkQ29uZmlncygpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjb25maWdzQWxyZWFkeVNhdmVkKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuaGFzQXRMZWFzdE9uZUNvbmZpZygpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRDb25maWcoY29uZmlnSWQ6IHN0cmluZyk6IE9wZW5JZENvbmZpZ3VyYXRpb24ge1xyXG4gICAgaWYgKCEhY29uZmlnSWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuY29uZmlnc0ludGVybmFsW2NvbmZpZ0lkXSB8fCBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IFssIHZhbHVlXSA9IE9iamVjdC5lbnRyaWVzKHRoaXMuY29uZmlnc0ludGVybmFsKVswXSB8fCBbW251bGwsIG51bGxdXTtcclxuXHJcbiAgICByZXR1cm4gdmFsdWUgfHwgbnVsbDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcHJlcGFyZUFuZFNhdmVDb25maWdzKHBhc3NlZENvbmZpZ3M6IE9wZW5JZENvbmZpZ3VyYXRpb25bXSk6IE9ic2VydmFibGU8T3BlbklkQ29uZmlndXJhdGlvbltdPiB7XHJcbiAgICBpZiAoIXRoaXMuY29uZmlnVmFsaWRhdGlvblNlcnZpY2UudmFsaWRhdGVDb25maWdzKHBhc3NlZENvbmZpZ3MpKSB7XHJcbiAgICAgIHJldHVybiBvZihudWxsKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmNyZWF0ZVVuaXF1ZUlkcyhwYXNzZWRDb25maWdzKTtcclxuICAgIGNvbnN0IGFsbEhhbmRsZUNvbmZpZ3MkID0gcGFzc2VkQ29uZmlncy5tYXAoKHgpID0+IHRoaXMuaGFuZGxlQ29uZmlnKHgpKTtcclxuXHJcbiAgICByZXR1cm4gZm9ya0pvaW4oYWxsSGFuZGxlQ29uZmlncyQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjcmVhdGVVbmlxdWVJZHMocGFzc2VkQ29uZmlnczogT3BlbklkQ29uZmlndXJhdGlvbltdKTogdm9pZCB7XHJcbiAgICBwYXNzZWRDb25maWdzLmZvckVhY2goKGNvbmZpZywgaW5kZXgpID0+IHtcclxuICAgICAgaWYgKCFjb25maWcuY29uZmlnSWQpIHtcclxuICAgICAgICBjb25maWcuY29uZmlnSWQgPSBgJHtpbmRleH0tJHtjb25maWcuY2xpZW50SWR9YDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUNvbmZpZyhwYXNzZWRDb25maWc6IE9wZW5JZENvbmZpZ3VyYXRpb24pOiBPYnNlcnZhYmxlPE9wZW5JZENvbmZpZ3VyYXRpb24+IHtcclxuICAgIGlmICghdGhpcy5jb25maWdWYWxpZGF0aW9uU2VydmljZS52YWxpZGF0ZUNvbmZpZyhwYXNzZWRDb25maWcpKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyU2VydmljZS5sb2dFcnJvcihwYXNzZWRDb25maWcsICdWYWxpZGF0aW9uIG9mIGNvbmZpZyByZWplY3RlZCB3aXRoIGVycm9ycy4gQ29uZmlnIGlzIE5PVCBzZXQuJyk7XHJcblxyXG4gICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFwYXNzZWRDb25maWcuYXV0aFdlbGxrbm93bkVuZHBvaW50VXJsKSB7XHJcbiAgICAgIHBhc3NlZENvbmZpZy5hdXRoV2VsbGtub3duRW5kcG9pbnRVcmwgPSBwYXNzZWRDb25maWcuYXV0aG9yaXR5O1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHVzZWRDb25maWcgPSB0aGlzLnByZXBhcmVDb25maWcocGFzc2VkQ29uZmlnKTtcclxuICAgIHRoaXMuc2F2ZUNvbmZpZyh1c2VkQ29uZmlnKTtcclxuXHJcbiAgICBjb25zdCBjb25maWdXaXRoQXV0aFdlbGxLbm93biA9IHRoaXMuZW5oYW5jZUNvbmZpZ1dpdGhXZWxsS25vd25FbmRwb2ludCh1c2VkQ29uZmlnKTtcclxuXHJcbiAgICB0aGlzLnB1YmxpY0V2ZW50c1NlcnZpY2UuZmlyZUV2ZW50PE9wZW5JZENvbmZpZ3VyYXRpb24+KEV2ZW50VHlwZXMuQ29uZmlnTG9hZGVkLCBjb25maWdXaXRoQXV0aFdlbGxLbm93bik7XHJcblxyXG4gICAgcmV0dXJuIG9mKHVzZWRDb25maWcpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBlbmhhbmNlQ29uZmlnV2l0aFdlbGxLbm93bkVuZHBvaW50KGNvbmZpZ3VyYXRpb246IE9wZW5JZENvbmZpZ3VyYXRpb24pOiBPcGVuSWRDb25maWd1cmF0aW9uIHtcclxuICAgIGNvbnN0IGFscmVhZHlFeGlzdGluZ0F1dGhXZWxsS25vd25FbmRwb2ludHMgPSB0aGlzLnN0b3JhZ2VQZXJzaXN0ZW5jZVNlcnZpY2UucmVhZCgnYXV0aFdlbGxLbm93bkVuZFBvaW50cycsIGNvbmZpZ3VyYXRpb24pO1xyXG4gICAgaWYgKCEhYWxyZWFkeUV4aXN0aW5nQXV0aFdlbGxLbm93bkVuZHBvaW50cykge1xyXG4gICAgICBjb25maWd1cmF0aW9uLmF1dGhXZWxsa25vd25FbmRwb2ludHMgPSBhbHJlYWR5RXhpc3RpbmdBdXRoV2VsbEtub3duRW5kcG9pbnRzO1xyXG5cclxuICAgICAgcmV0dXJuIGNvbmZpZ3VyYXRpb247XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcGFzc2VkQXV0aFdlbGxLbm93bkVuZHBvaW50cyA9IGNvbmZpZ3VyYXRpb24uYXV0aFdlbGxrbm93bkVuZHBvaW50cztcclxuICAgIGlmICghIXBhc3NlZEF1dGhXZWxsS25vd25FbmRwb2ludHMpIHtcclxuICAgICAgdGhpcy5hdXRoV2VsbEtub3duU2VydmljZS5zdG9yZVdlbGxLbm93bkVuZHBvaW50cyhjb25maWd1cmF0aW9uLCBwYXNzZWRBdXRoV2VsbEtub3duRW5kcG9pbnRzKTtcclxuICAgICAgY29uZmlndXJhdGlvbi5hdXRoV2VsbGtub3duRW5kcG9pbnRzID0gcGFzc2VkQXV0aFdlbGxLbm93bkVuZHBvaW50cztcclxuXHJcbiAgICAgIHJldHVybiBjb25maWd1cmF0aW9uO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBjb25maWd1cmF0aW9uO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwcmVwYXJlQ29uZmlnKGNvbmZpZ3VyYXRpb246IE9wZW5JZENvbmZpZ3VyYXRpb24pOiBPcGVuSWRDb25maWd1cmF0aW9uIHtcclxuICAgIGNvbnN0IG9wZW5JZENvbmZpZ3VyYXRpb25JbnRlcm5hbCA9IHsgLi4uREVGQVVMVF9DT05GSUcsIC4uLmNvbmZpZ3VyYXRpb24gfTtcclxuICAgIHRoaXMuc2V0U3BlY2lhbENhc2VzKG9wZW5JZENvbmZpZ3VyYXRpb25JbnRlcm5hbCk7XHJcblxyXG4gICAgcmV0dXJuIG9wZW5JZENvbmZpZ3VyYXRpb25JbnRlcm5hbDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0U3BlY2lhbENhc2VzKGN1cnJlbnRDb25maWc6IE9wZW5JZENvbmZpZ3VyYXRpb24pOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5wbGF0Zm9ybVByb3ZpZGVyLmlzQnJvd3NlcigpKSB7XHJcbiAgICAgIGN1cnJlbnRDb25maWcuc3RhcnRDaGVja1Nlc3Npb24gPSBmYWxzZTtcclxuICAgICAgY3VycmVudENvbmZpZy5zaWxlbnRSZW5ldyA9IGZhbHNlO1xyXG4gICAgICBjdXJyZW50Q29uZmlnLnVzZVJlZnJlc2hUb2tlbiA9IGZhbHNlO1xyXG4gICAgICBjdXJyZW50Q29uZmlnLnVzZVB1c2hlZEF1dGhvcmlzYXRpb25SZXF1ZXN0cyA9IGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=
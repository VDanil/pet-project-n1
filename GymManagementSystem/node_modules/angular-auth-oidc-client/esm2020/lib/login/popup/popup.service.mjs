import { DOCUMENT } from '@angular/common';
import { Inject, Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
export class PopUpService {
    constructor(document) {
        this.document = document;
        this.STORAGE_IDENTIFIER = 'popupauth';
        this.resultInternal$ = new Subject();
    }
    get result$() {
        return this.resultInternal$.asObservable();
    }
    get windowInternal() {
        return this.document.defaultView;
    }
    isCurrentlyInPopup() {
        if (this.canAccessSessionStorage()) {
            const popup = sessionStorage.getItem(this.STORAGE_IDENTIFIER);
            return !!this.windowInternal.opener && this.windowInternal.opener !== this.windowInternal && !!popup;
        }
        return false;
    }
    openPopUp(url, popupOptions) {
        const optionsToPass = this.getOptions(popupOptions);
        this.popUp = this.windowInternal.open(url, '_blank', optionsToPass);
        this.popUp.sessionStorage.setItem(this.STORAGE_IDENTIFIER, 'true');
        const listener = (event) => {
            if (!event?.data || typeof event.data !== 'string') {
                return;
            }
            this.resultInternal$.next({ userClosed: false, receivedUrl: event.data });
            this.cleanUp(listener);
        };
        this.windowInternal.addEventListener('message', listener, false);
        this.handle = this.windowInternal.setInterval(() => {
            if (this.popUp.closed) {
                this.resultInternal$.next({ userClosed: true });
                this.cleanUp(listener);
            }
        }, 200);
    }
    sendMessageToMainWindow(url) {
        if (this.windowInternal.opener) {
            const href = this.windowInternal.location.href;
            this.sendMessage(url, href);
        }
    }
    cleanUp(listener) {
        this.windowInternal.removeEventListener('message', listener, false);
        this.windowInternal.clearInterval(this.handle);
        if (this.popUp) {
            this.popUp.sessionStorage?.removeItem(this.STORAGE_IDENTIFIER);
            this.popUp.close();
            this.popUp = null;
        }
    }
    sendMessage(url, href) {
        this.windowInternal.opener.postMessage(url, href);
    }
    getOptions(popupOptions) {
        const popupDefaultOptions = { width: 500, height: 500, left: 50, top: 50 };
        const options = { ...popupDefaultOptions, ...(popupOptions || {}) };
        const left = this.windowInternal.screenLeft + (this.windowInternal.outerWidth - options.width) / 2;
        const top = this.windowInternal.screenTop + (this.windowInternal.outerHeight - options.height) / 2;
        options.left = left;
        options.top = top;
        return Object.entries(options)
            .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
            .join(',');
    }
    canAccessSessionStorage() {
        return typeof navigator !== 'undefined' && navigator.cookieEnabled && typeof Storage !== 'undefined';
    }
}
PopUpService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: PopUpService, deps: [{ token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable });
PopUpService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: PopUpService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.1.0", ngImport: i0, type: PopUpService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: Document, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wdXAuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItYXV0aC1vaWRjLWNsaWVudC9zcmMvbGliL2xvZ2luL3BvcHVwL3BvcHVwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7O0FBSzNDLE1BQU0sT0FBTyxZQUFZO0lBY3ZCLFlBQXNDLFFBQWtCO1FBQWxCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFiaEQsdUJBQWtCLEdBQUcsV0FBVyxDQUFDO1FBR2pDLG9CQUFlLEdBQUcsSUFBSSxPQUFPLEVBQWUsQ0FBQztJQVVNLENBQUM7SUFSNUQsSUFBSSxPQUFPO1FBQ1QsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFFRCxJQUFZLGNBQWM7UUFDeEIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQztJQUNuQyxDQUFDO0lBSUQsa0JBQWtCO1FBQ2hCLElBQUksSUFBSSxDQUFDLHVCQUF1QixFQUFFLEVBQUU7WUFDbEMsTUFBTSxLQUFLLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUU5RCxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsY0FBYyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUM7U0FDdEc7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCxTQUFTLENBQUMsR0FBVyxFQUFFLFlBQTJCO1FBQ2hELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQ3BFLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFbkUsTUFBTSxRQUFRLEdBQUcsQ0FBQyxLQUFtQixFQUFRLEVBQUU7WUFDN0MsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLElBQUksT0FBTyxLQUFLLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtnQkFDbEQsT0FBTzthQUNSO1lBRUQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUUxRSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQztRQUVGLElBQUksQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUVqRSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRTtZQUNqRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO2dCQUNyQixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2dCQUVoRCxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ3hCO1FBQ0gsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ1YsQ0FBQztJQUVELHVCQUF1QixDQUFDLEdBQVc7UUFDakMsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRTtZQUM5QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7WUFFL0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDN0I7SUFDSCxDQUFDO0lBRU8sT0FBTyxDQUFDLFFBQWE7UUFDM0IsSUFBSSxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXBFLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUvQyxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZCxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxVQUFVLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDL0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztTQUNuQjtJQUNILENBQUM7SUFFTyxXQUFXLENBQUMsR0FBVyxFQUFFLElBQVk7UUFDM0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRU8sVUFBVSxDQUFDLFlBQTJCO1FBQzVDLE1BQU0sbUJBQW1CLEdBQWlCLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBRXpGLE1BQU0sT0FBTyxHQUFpQixFQUFFLEdBQUcsbUJBQW1CLEVBQUUsR0FBRyxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ2xGLE1BQU0sSUFBSSxHQUFXLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzRyxNQUFNLEdBQUcsR0FBVyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsR0FBRyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0csT0FBTyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDcEIsT0FBTyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFFbEIsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQzthQUMzQixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2FBQ2hGLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNmLENBQUM7SUFFTyx1QkFBdUI7UUFDN0IsT0FBTyxPQUFPLFNBQVMsS0FBSyxXQUFXLElBQUksU0FBUyxDQUFDLGFBQWEsSUFBSSxPQUFPLE9BQU8sS0FBSyxXQUFXLENBQUM7SUFDdkcsQ0FBQzs7eUdBNUZVLFlBQVksa0JBY0gsUUFBUTs2R0FkakIsWUFBWSxjQURDLE1BQU07MkZBQ25CLFlBQVk7a0JBRHhCLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFOzBEQWVnQixRQUFROzBCQUEzQyxNQUFNOzJCQUFDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFBvcHVwT3B0aW9ucyB9IGZyb20gJy4vcG9wdXAtb3B0aW9ucyc7XG5pbXBvcnQgeyBQb3B1cFJlc3VsdCB9IGZyb20gJy4vcG9wdXAtcmVzdWx0JztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBQb3BVcFNlcnZpY2Uge1xuICBwcml2YXRlIFNUT1JBR0VfSURFTlRJRklFUiA9ICdwb3B1cGF1dGgnO1xuICBwcml2YXRlIHBvcFVwOiBXaW5kb3c7XG4gIHByaXZhdGUgaGFuZGxlOiBudW1iZXI7XG4gIHByaXZhdGUgcmVzdWx0SW50ZXJuYWwkID0gbmV3IFN1YmplY3Q8UG9wdXBSZXN1bHQ+KCk7XG5cbiAgZ2V0IHJlc3VsdCQoKTogT2JzZXJ2YWJsZTxQb3B1cFJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLnJlc3VsdEludGVybmFsJC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IHdpbmRvd0ludGVybmFsKCk6IFdpbmRvdyB7XG4gICAgcmV0dXJuIHRoaXMuZG9jdW1lbnQuZGVmYXVsdFZpZXc7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIGRvY3VtZW50OiBEb2N1bWVudCkge31cblxuICBpc0N1cnJlbnRseUluUG9wdXAoKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMuY2FuQWNjZXNzU2Vzc2lvblN0b3JhZ2UoKSkge1xuICAgICAgY29uc3QgcG9wdXAgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKHRoaXMuU1RPUkFHRV9JREVOVElGSUVSKTtcblxuICAgICAgcmV0dXJuICEhdGhpcy53aW5kb3dJbnRlcm5hbC5vcGVuZXIgJiYgdGhpcy53aW5kb3dJbnRlcm5hbC5vcGVuZXIgIT09IHRoaXMud2luZG93SW50ZXJuYWwgJiYgISFwb3B1cDtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBvcGVuUG9wVXAodXJsOiBzdHJpbmcsIHBvcHVwT3B0aW9ucz86IFBvcHVwT3B0aW9ucyk6IHZvaWQge1xuICAgIGNvbnN0IG9wdGlvbnNUb1Bhc3MgPSB0aGlzLmdldE9wdGlvbnMocG9wdXBPcHRpb25zKTtcbiAgICB0aGlzLnBvcFVwID0gdGhpcy53aW5kb3dJbnRlcm5hbC5vcGVuKHVybCwgJ19ibGFuaycsIG9wdGlvbnNUb1Bhc3MpO1xuICAgIHRoaXMucG9wVXAuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSh0aGlzLlNUT1JBR0VfSURFTlRJRklFUiwgJ3RydWUnKTtcblxuICAgIGNvbnN0IGxpc3RlbmVyID0gKGV2ZW50OiBNZXNzYWdlRXZlbnQpOiB2b2lkID0+IHtcbiAgICAgIGlmICghZXZlbnQ/LmRhdGEgfHwgdHlwZW9mIGV2ZW50LmRhdGEgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5yZXN1bHRJbnRlcm5hbCQubmV4dCh7IHVzZXJDbG9zZWQ6IGZhbHNlLCByZWNlaXZlZFVybDogZXZlbnQuZGF0YSB9KTtcblxuICAgICAgdGhpcy5jbGVhblVwKGxpc3RlbmVyKTtcbiAgICB9O1xuXG4gICAgdGhpcy53aW5kb3dJbnRlcm5hbC5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgbGlzdGVuZXIsIGZhbHNlKTtcblxuICAgIHRoaXMuaGFuZGxlID0gdGhpcy53aW5kb3dJbnRlcm5hbC5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5wb3BVcC5jbG9zZWQpIHtcbiAgICAgICAgdGhpcy5yZXN1bHRJbnRlcm5hbCQubmV4dCh7IHVzZXJDbG9zZWQ6IHRydWUgfSk7XG5cbiAgICAgICAgdGhpcy5jbGVhblVwKGxpc3RlbmVyKTtcbiAgICAgIH1cbiAgICB9LCAyMDApO1xuICB9XG5cbiAgc2VuZE1lc3NhZ2VUb01haW5XaW5kb3codXJsOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy53aW5kb3dJbnRlcm5hbC5vcGVuZXIpIHtcbiAgICAgIGNvbnN0IGhyZWYgPSB0aGlzLndpbmRvd0ludGVybmFsLmxvY2F0aW9uLmhyZWY7XG5cbiAgICAgIHRoaXMuc2VuZE1lc3NhZ2UodXJsLCBocmVmKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNsZWFuVXAobGlzdGVuZXI6IGFueSk6IHZvaWQge1xuICAgIHRoaXMud2luZG93SW50ZXJuYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGxpc3RlbmVyLCBmYWxzZSk7XG5cbiAgICB0aGlzLndpbmRvd0ludGVybmFsLmNsZWFySW50ZXJ2YWwodGhpcy5oYW5kbGUpO1xuXG4gICAgaWYgKHRoaXMucG9wVXApIHtcbiAgICAgIHRoaXMucG9wVXAuc2Vzc2lvblN0b3JhZ2U/LnJlbW92ZUl0ZW0odGhpcy5TVE9SQUdFX0lERU5USUZJRVIpO1xuICAgICAgdGhpcy5wb3BVcC5jbG9zZSgpO1xuICAgICAgdGhpcy5wb3BVcCA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZW5kTWVzc2FnZSh1cmw6IHN0cmluZywgaHJlZjogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy53aW5kb3dJbnRlcm5hbC5vcGVuZXIucG9zdE1lc3NhZ2UodXJsLCBocmVmKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0T3B0aW9ucyhwb3B1cE9wdGlvbnM/OiBQb3B1cE9wdGlvbnMpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBvcHVwRGVmYXVsdE9wdGlvbnM6IFBvcHVwT3B0aW9ucyA9IHsgd2lkdGg6IDUwMCwgaGVpZ2h0OiA1MDAsIGxlZnQ6IDUwLCB0b3A6IDUwIH07XG5cbiAgICBjb25zdCBvcHRpb25zOiBQb3B1cE9wdGlvbnMgPSB7IC4uLnBvcHVwRGVmYXVsdE9wdGlvbnMsIC4uLihwb3B1cE9wdGlvbnMgfHwge30pIH07XG4gICAgY29uc3QgbGVmdDogbnVtYmVyID0gdGhpcy53aW5kb3dJbnRlcm5hbC5zY3JlZW5MZWZ0ICsgKHRoaXMud2luZG93SW50ZXJuYWwub3V0ZXJXaWR0aCAtIG9wdGlvbnMud2lkdGgpIC8gMjtcbiAgICBjb25zdCB0b3A6IG51bWJlciA9IHRoaXMud2luZG93SW50ZXJuYWwuc2NyZWVuVG9wICsgKHRoaXMud2luZG93SW50ZXJuYWwub3V0ZXJIZWlnaHQgLSBvcHRpb25zLmhlaWdodCkgLyAyO1xuICAgIG9wdGlvbnMubGVmdCA9IGxlZnQ7XG4gICAgb3B0aW9ucy50b3AgPSB0b3A7XG5cbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMob3B0aW9ucylcbiAgICAgIC5tYXAoKFtrZXksIHZhbHVlXSkgPT4gYCR7ZW5jb2RlVVJJQ29tcG9uZW50KGtleSl9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKX1gKVxuICAgICAgLmpvaW4oJywnKTtcbiAgfVxuXG4gIHByaXZhdGUgY2FuQWNjZXNzU2Vzc2lvblN0b3JhZ2UoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci5jb29raWVFbmFibGVkICYmIHR5cGVvZiBTdG9yYWdlICE9PSAndW5kZWZpbmVkJztcbiAgfVxufVxuIl19